<!DOCTYPE html>
<head>
  <title>Wiki</title>
  <link rel="icon" href="icon-120.png" />
  <link rel="stylesheet" href="./@observablehq/inspector@5/dist/inspector.css" />
  <script type="module">
   import {Runtime, Inspector} from './@observablehq/runtime@5/dist/runtime.js';
   import {Library} from './src/library.js';
   import {notebook} from './src/notebook.js';
   import {Plugins} from './src/plugins/index.js';
   const notebookFromPanel = notebook(Plugins);
   const lineup = [];
   const neighborhood = new Map();
   const sitemaps = new Map();

   function randomId() {
     let x = new Uint32Array(2);
     crypto.getRandomValues(x);
     return Array.from(x, i=>i.toString(16)).join('');
   }

   function intentFromLocation(location) {
     let params = new URLSearchParams(location.search);
     if (params.has('url')) {
       return {
         intent: 'fetch',
         url: new URL(params.get('url'), location.origin)
       };
     }
     return {
       intent: 'unknown'
     };
   }

   function contextFromPage(page) {
     const storyItemIds = page.story.reduce(
       (s, i) => (s.add(i.id), s),
       new Set()
     );
     return page.journal.reverse().reduce((acc, change) => {
       if (change.site) acc.page.add(change.site);
       if (change.attribution?.site && storyItemIds.has(change.id)) {
         const {site} = change.attribution;
         acc.item.set(change.id, {site});
       }
       return acc;
     }, {
       page: new Set(),
       item: new Map()
     });
   }

   function expandNeighborhoodFromContext(context) {
     for(let site of context.page) {
       neighborhood.set(site, null);
     }
     for(let {site} of context.item.values()) {
       neighborhood.set(site, null);
     }
   }
   window.onload = async () => {
     let action = intentFromLocation(location);
     if (action.intent === 'unknown') return;
     const runtime = new Runtime(Library);
     if (action.intent === 'fetch') {
       const res = await fetch(action.url, {mode: 'cors'});
       const page = await res.json();
       const panel = {
         id: randomId(), flag: '',
         page
       };
       const module = runtime.module(
         notebookFromPanel(panel),
         name => (name == 'panel') ? Inspector.into('main')() : null);
       const context = contextFromPage(panel.page);
       lineup.push({
         title: page.title,
         panel,
         module,
         context
       });
       expandNeighborhoodFromContext(context);
     }
     window.wiki = {
       lineup,
       neighborhood,
       sitemaps
     }
   };
  </script>
</head>
<main></main>
